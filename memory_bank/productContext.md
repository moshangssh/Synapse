# 产品背景

本项目旨在创建一个使用 Tauri, React, 和 FastAPI 构建的桌面应用程序。

## DaVinci Resolve 字幕提取应用 (2025-07-23)

**项目目标:**
开发一个采用前后端分离架构的独立应用程序。该应用的后端负责连接到正在运行的 DaVinci Resolve 实例，并从当前活动时间线的指定字幕轨道中提取所有字幕条目。前端则以一个清晰的MUI表格界面来实时展示和刷新这些字幕数据。

**技术架构要求:**
1.  **后端:** 使用 Python + FastAPI 实现。后端将作为服务端，封装所有与 DaVinci Resolve Scripting API 的交互逻辑。
2.  **前端:** 一个基于 React + Tauri + MUI 技术的用户界面，用于数据显示和用户交互。
3.  **通信协议:** 后端需提供一个 RESTful API 接口，供前端调用以获取字幕数据。

**核心功能流程:**
1.  **连接管理:** 应用程序启动时，后端主动尝试连接到本地正在运行的 DaVinci Resolve 实例。
2.  **API 端点:** 后端至少需要实现一个 API 端点 (例如: `GET /api/v1/subtitles`) 用于提供字幕数据。
3.  **数据提取逻辑:**
    *   当 API 端点被调用时，后端脚本需要执行以下操作：
        a. 获取 DaVinci Resolve 的当前项目 (Project)。
        b. 获取项目中的当前活动时间线 (Timeline)。
        c. 定位到时间线上的第一个字幕轨道 (Subtitle Track)。
        d. 遍历该轨道上的所有字幕片段 (Subtitle Items)。
        e. 对每个字幕片段，精确提取其**起始时间码 (Start Timecode)**、**结束时间码 (End Timecode)** 以及**字幕文本内容 (Text)**。
4.  **数据格式化:** 后端将提取到的数据整理成一个 JSON 对象数组，每个对象代表一条字幕。

**前端界面要求:**
1.  **数据显示:**
    *   设计一个表格 (Table) 来展示字幕数据。
    *   表格应至少包含以下列：“序号”、“起始时间码”、“结束时间码”、“字幕内容”。
2.  **用户交互:**
    *   提供一个“刷新”按钮，点击后会重新从 DaVinci Resolve 获取最新的字幕数据并更新表格。
    *   在界面上明确显示与 DaVinci Resolve 的连接状态（例如：“已连接”、“连接中”、“错误：未找到 DaVinci Resolve 实例”）。
    *   **查找与替换:**
        *   提供输入框用于输入查找内容和替换内容。
        *   提供“查找下一个”、“全部替换”按钮。
        *   高亮显示当前匹配的查找结果。

**数据结构定义 (JSON 示例):**
```json
{
  "status": "success",
  "data": [
    {
      "id": 1,
      "startTimecode": "01:00:02:10",
      "endTimecode": "01:00:05:15",
      "text": "这是第一条字幕。"
    },
    {
      "id": 2,
      "startTimecode": "01:00:06:00",
      "endTimecode": "01:00:09:20",
      "text": "这是第二条字幕，用于演示。"
    }
  ]
}
```

**错误处理机制:**
*   **Resolve 未运行:** 如果后端无法连接到 DaVinci Resolve，API 应返回明确的错误信息和状态码（例如 503 Service Unavailable）。
*   **无打开项目/时间线:** 如果 Resolve 正在运行但没有打开的项目或活动时间线，API 应返回相应的状态信息。
*   **无字幕轨道:** 如果当前时间线上不存在字幕轨道，API 应返回一个空的数据数组。

**核心约束:**
**此应用程序必须作为一个独立的进程运行**，而不是作为插件在 DaVinci Resolve 内部执行。它需要自行管理与 Resolve 应用程序的生命周期和通信连接。在设计时请务必充分考虑此运行模式。

---

## 新增功能：导出字幕至达芬奇 (2025-07-26)

**需求:**
- 在现有的“导出SRT”功能基础上，新增一个“导出字幕至达芬奇”的功能。
- 后端需要实现一个新的API端点 (`POST /api/v1/export/davinci`)。
- 该API的核心逻辑是：
    1.  将接收到的字幕数据生成一个临时的SRT文件。
    2.  调用DaVinci Resolve的 `media_pool.ImportMedia()` API，将SRT文件作为一个新的字幕媒体项导入到当前的媒体池（Media Pool）。
    3.  成功导入后，得到一个指向该字幕媒体项的引用 (`subtitle_pool_item`)。
    4.  调用 `media_pool.AppendToTimeline()` API，将这个媒体项添加到时间线上。
- 前端需要在UI上添加一个相应的按钮，并实现调用新API的逻辑。

---

## 功能更新：导出至达芬奇的用户体验优化 (2025-07-26)

**变更:**
- “导出至达芬奇”功能现在会在操作完成后，**自动将新导入的字幕轨道设置为当前活动的轨道**。

**旧行为:**
- 导入操作后，系统会恢复到导入前的轨道状态，用户需要手动查找并切换到新轨道。

**新行为:**
- 导入操作后，新字幕轨道会立即显示在时间线上，用户可以无缝地开始预览和编辑，无需任何额外的手动切换操作。

---

## UI/UX 整体升级：移植VSCode风格布局 (2025-07-27)

**项目目标:**
为了提升应用的专业性和用户体验，将现有前端UI替换为一个功能更丰富、布局更现代的VSCode风格界面。

**技术方案:**
1.  **新布局**: 采用一个包含“活动栏”、“侧边栏”、“编辑器区域”和“状态栏”的复合式布局。
2.  **组件化集成**:
    *   将现有的核心功能（字幕表格、查找替换等）封装成一个独立的“字幕编辑器”页面。
    *   将这个页面作为新布局中“编辑器区域”的主要内容。
3.  **视图切换**: 通过“活动栏”的图标，可以切换“侧边栏”中显示的内容，例如“文件浏览器”、“搜索”等。
4.  **主题统一**: 整个应用将采用一个新的、统一的深色主题，以匹配VSCode的视觉风格。

**核心约束:**
- 必须完整保留所有现有的字幕处理和导出功能。
- 移植过程应平滑，确保新旧功能的无缝集成。

---

## 功能更新：高级侧边栏搜索 (2025-07-27)

**变更:**
- **功能迁移与UI重构:**
  - 原位于主编辑区的“查找/替换”功能，现已完全迁移至左侧的“搜索”侧边栏中。
  - 其UI已根据用户的精确反馈，一比一复刻了VS Code的原生样式，包括可折叠的替换框和动态对齐的交互细节。
- **新增实时结果列表:**
  - 在“查找/替换”组件下方，新增了一个实时搜索结果列表。
  - 该列表仅在用户输入搜索词时显示，并能准确列出所有匹配的字幕。
- **点击跳转功能:**
  - 用户可以点击搜索结果列表中的任意一项，主编辑区的字幕表格会自动滚动到对应的行，同时播放头也会跳转到该字幕的起始时间码。
- **交互逻辑解耦:**
  - 主字幕表格不再受搜索框影响，始终显示完整的字幕列表。搜索功能现在仅作用于侧边栏的搜索结果列表，实现了更清晰的交互分离。

**新行为:**
- 用户现在可以在一个专用的、高度仿真的VS Code风格侧边栏中，完成从“搜索”、“定位”到“替换”的完整工作流，极大地提升了在处理大量字幕时的操作效率和体验。

---

## 功能更新：字幕编辑功能 (2025-08-01)

**变更:**
- **新增字幕编辑功能:**
  - 用户现在可以通过双击字幕行来编辑字幕内容。
  - 编辑后的字幕内容会以diff样式显示差异，方便用户查看修改内容。
  - 该功能使用现有的diff样式组件，保持了界面的一致性。

**实现细节:**
- 在`useDataStore`中更新了`updateSubtitleText`函数，使其在更新字幕文本的同时也更新diffs字段。
- 确保originalText字段在首次编辑时被正确设置。
- 使用calculateDiff函数计算新的diffs并更新diffs字段。

**新行为:**
- 用户可以通过双击字幕行来编辑字幕内容，编辑后的差异会以高亮显示，提升了用户体验。

---

## 功能更新：窗口置顶 (2025-08-02)

**变更:**
- **新增窗口置顶功能:**
  - 在自定义标题栏右侧的窗口控制区添加了一个置顶按钮，位于最小化按钮的左侧，允许用户将应用窗口始终保持在其他窗口之上。
  - 按钮图标会根据窗口当前的置顶状态动态切换（置顶时显示“图钉按下”图标，非置顶时显示“图钉弹起”图标）。
  - 在自定义标题栏右侧添加了最小化、最大化和关闭按钮，实现了完整的窗口控制功能。

**实现细节:**
- 使用Tauri API `@tauri-apps/api/window`中的`getCurrentWindow().setAlwaysOnTop()`方法控制窗口置顶状态。
- 使用Material-UI的`PushPin`和`PushPinOutlined`图标表示置顶和非置顶状态。
- 使用Tauri API实现了窗口的最小化、最大化/还原和关闭功能。
- 修改了`tauri.conf.json`文件，添加了`"decorations": false`配置以禁用系统默认标题栏。

**新行为:**
- 用户可以通过点击标题栏右侧控制区的置顶按钮来切换窗口的置顶状态，提升了在多任务处理时的使用体验。
- 用户可以通过自定义标题栏右侧的按钮来控制窗口的最小化、最大化和关闭，提供了与操作系统原生标题栏类似的体验。